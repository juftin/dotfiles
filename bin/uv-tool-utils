#!/usr/bin/env bash

set -e

if ! command -v uv &>/dev/null; then
	echo "‚ùå uv is not installed. Please install uv first."
	exit 1
fi

function uv_install() {
	local PACKAGE="${1}"
	shift
	local EXTRA_ARGS=("$@")

	if [[ ${PACKAGE} == *" @ "* ]]; then
		local CLEAN_PACKAGE="${PACKAGE%% @ *}"
	elif [[ ${PACKAGE} == *"["* ]]; then
		local CLEAN_PACKAGE="${PACKAGE%%[*}"
	else
		local CLEAN_PACKAGE="${PACKAGE}"
	fi
	echo "üì¶ Installing ${CLEAN_PACKAGE}"
	uv tool install --upgrade "${PACKAGE}" "${EXTRA_ARGS[@]}"
}

function uv_tool_install_file() {
	local FILE="${1}"

	if [ ! -f "${FILE}" ]; then
		echo "‚ùå File not found: ${FILE}"
		exit 1
	fi

	while IFS= read -r line; do
		if [[ ${line} =~ ^[^#]*$ ]] && [[ -n ${line} ]]; then
			local PACKAGE="${line%%#*}"
			uv_install ${PACKAGE}
		fi
	done <"${FILE}"
}

PRIMARY_COMMAND="${1}"
PACKAGE="${2}"

if [ -z "${PRIMARY_COMMAND}" ] && [ -z "${PACKAGE}" ]; then
	echo "üì¶ uv-tool-utils"
	echo "Usage: uv-tool-utils <command> <package>"
	echo ""
	echo "Commands:"
	echo "  install <package>     Install or upgrade a package"
	echo "  install-file <file>   Install or upgrade packages from a file"
	echo "  uninstall <package>   Uninstall a package"
	echo "  upgrade <package>     Upgrade a package"
	echo "  list                  List installed packages"
	exit 1
fi

case ${PRIMARY_COMMAND} in
install)
	uv_install "${PACKAGE}"
	;;
install-file)
	uv_tool_install_file "${PACKAGE}"
	;;
uninstall)
	uv tool uninstall "${PACKAGE}"
	;;
upgrade)
	piuv tool upgrade "${PACKAGE}"
	;;
list)
	uv tool list
	;;
*)
	echo "‚ùå Invalid command. Please use 'install', 'uninstall', 'upgrade', or 'list'."
	exit 1
	;;
esac
